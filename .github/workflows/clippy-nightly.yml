name: Clippy Nightly

on:
  schedule:
    # Run daily at 6:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  CARGO_TERM_COLOR: always

jobs:
  clippy-nightly:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache CUDA toolkit
        id: cache-cuda
        uses: actions/cache@v4
        with:
          path: ~/cuda-toolkit
          key: cuda-toolkit-12-6-ubuntu2404-v5

      - name: Install CUDA toolkit
        if: steps.cache-cuda.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y cuda-toolkit-12-6 libcublas-12-6 libcublas-dev-12-6
          mkdir -p ~/cuda-toolkit
          cp -a /usr/local/cuda-12.6/* ~/cuda-toolkit/

      - name: Restore CUDA toolkit from cache
        if: steps.cache-cuda.outputs.cache-hit == 'true'
        run: |
          sudo mkdir -p /usr/local/cuda-12.6
          sudo cp -a ~/cuda-toolkit/* /usr/local/cuda-12.6/
          sudo chmod -R a+rX /usr/local/cuda-12.6/
          sudo ldconfig

      - name: Set CUDA environment
        run: |
          echo "/usr/local/cuda-12.6/bin" >> $GITHUB_PATH
          CUDA_LIB="/usr/local/cuda-12.6/lib64"
          CUDA_TARGETS_LIB="/usr/local/cuda-12.6/targets/x86_64-linux/lib"
          echo "LD_LIBRARY_PATH=${CUDA_LIB}:${CUDA_TARGETS_LIB}:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          sudo ldconfig ${CUDA_LIB} ${CUDA_TARGETS_LIB}

      - name: Install Triton
        run: |
          python3 -m venv .venv
          .venv/bin/pip install triton
          echo "VIRTUAL_ENV=$PWD/.venv" >> $GITHUB_ENV

      - name: Install Rust nightly
        run: rustup toolchain install nightly --component clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-nightly-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Clippy nightly (pedantic)
        run: cargo +nightly clippy --all --all-features -- -W clippy::pedantic -D warnings
