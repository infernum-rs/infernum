name: Clippy Nightly

on:
  schedule:
    # Run daily at 6:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  CARGO_TERM_COLOR: always

jobs:
  clippy-nightly:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        run: |
          rustup toolchain install nightly --component clippy
          rustup override set nightly

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-nightly-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Clippy nightly (pedantic)
        run: cargo clippy -- -W clippy::pedantic

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Clippy nightly failed on ${new Date().toISOString().split('T')[0]}`,
              body: `The nightly Clippy check has failed.\n\nSee the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
              labels: ['clippy', 'automation']
            });
            console.log(`Created issue #${issue.data.number}`);
